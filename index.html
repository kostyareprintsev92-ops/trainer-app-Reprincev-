<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Приложение тренера</title>
  <style>
    body{margin:0;background:#f6f6f6;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1120px;margin:14px auto;padding:0 12px}
    .bar{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;justify-content:space-between;
         background:rgba(255,255,255,.9);border-bottom:1px solid #eee;padding:10px 12px;backdrop-filter:blur(6px)}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:12px}
    .card{background:#fff;border:1px solid #e5e5e5;border-radius:14px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .ttl{font-weight:700;margin-bottom:8px}
    .in{padding:8px 10px;border:1px solid #d4d4d4;border-radius:10px;outline:none}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #000;background:#000;color:#fff;cursor:pointer}
    .btnL{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btnD{padding:8px 12px;border-radius:10px;border:1px solid #fecaca;background:#fff;color:#b91c1c;cursor:pointer}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th{position:sticky;top:0;background:#fff;text-align:left;color:#666;border-bottom:1px solid #eee;padding:8px 10px}
    td{border-bottom:1px solid #f0f0f0;padding:8px 10px;vertical-align:top}
    .muted{color:#666}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
  <!-- React UMD + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div class="bar">
    <b>Приложение тренера</b>
    <div style="display:flex;gap:6px">
      <button class="btnL" onclick="window.setView('list')">Список</button>
      <button class="btnL" onclick="window.setView('stats')">Статистика</button>
    </div>
  </div>
  <div class="wrap"><div id="root"></div></div>

  <script type="text/babel">
  const {useState,useEffect,useMemo} = React;

  /* ===== utils & storage ===== */
  const gid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
  const save=(k,v)=>{try{localStorage.setItem("ts:"+k,JSON.stringify(v))}catch{}}
  const load=(k,f)=>{try{const r=localStorage.getItem("ts:"+k);return r?JSON.parse(r):f}catch{return f}}
  const toLocal=(d)=>{const off=d.getTimezoneOffset();return new Date(d.getTime()-off*60000).toISOString().slice(0,16)}
  const fromLocal=(s)=>{const d=new Date(s);const off=new Date().getTimezoneOffset();return new Date(d.getTime()+off*60000)}
  const dstr=(d)=>new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"}).format(d);
  const tstr=(d)=>String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");

  /* ========= APP ========= */
  function App(){
    const [clients,setClients]=useState(()=>load("clients",[]));
    const [sessions,setSessions]=useState(()=>load("sessions",[]));
    const [view,setView]=useState(()=>load("view","list"));
    const [q,setQ]=useState("");

    useEffect(()=>save("clients",clients),[clients]);
    useEffect(()=>save("sessions",sessions),[sessions]);
    useEffect(()=>save("view",view),[view]);
    useEffect(()=>{ window.setView = setView; },[]);

    /* ---- clients ---- */
    const addClient=()=>{
      const name=(prompt("Имя клиента")||"").trim();
      if(!name) return;
      const size=+prompt("Размер пакета (0 — без пакета)", "0")||0;
      const price=+prompt("Цена пакета (₽)", "0")||0;
      setClients(p=>[...p,{id:gid(),name,phone:"",note:"",package: size>0?{size,price,left:size}:null}]);
    };
    const editClient=(c)=>{
      const name=prompt("Имя",c.name)??c.name;
      const phone=prompt("Телефон",c.phone||"")??c.phone;
      const note=prompt("Заметка",c.note||"")??c.note;
      let pkg=c.package;
      if(confirm("Изменить пакет?")){
        const size=+prompt("Размер пакета (0 — убрать)",pkg?.size||0)||0;
        const price=+prompt("Цена пакета (₽)",pkg?.price||0)||0;
        pkg = size>0?{size,price,left:Math.min(pkg?.left??size,size)}:null;
      }
      setClients(p=>p.map(x=>x.id===c.id?{...x,name,phone,note,package:pkg}:x));
    };
    const removeClient=(id)=>{
      if(!confirm("Удалить клиента и убрать его из тренировок?")) return;
      setClients(p=>p.filter(c=>c.id!==id));
      setSessions(p=>p.map(s=>({...s,clients:(s.clients||[]).filter(cid=>cid!==id)})));
    };

    /* ---- quick create ---- */
    function QuickCreate(){
      const [title,setTitle]=useState("");
      const [start,setStart]=useState(()=>toLocal(new Date()));
      const [dur,setDur]=useState(60);
      const [rate,setRate]=useState(0);
      const [ids,setIds]=useState([]);
      return (
        <div style={{display:"grid",gap:8}}>
          <input className="in" placeholder="Название" value={title} onChange={e=>setTitle(e.target.value)}/>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <input className="in" type="datetime-local" value={start} onChange={e=>setStart(e.target.value)}/>
            <input className="in" style={{width:90}} type="number" min={15} step={15} value={dur} onChange={e=>setDur(+e.target.value||60)}/>
            <span className="muted">мин</span>
          </div>
          <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
            {clients.map(c=>{
              const on=ids.includes(c.id);
              return (
                <button key={c.id} className="chip"
                  onClick={()=>setIds(v=>on?v.filter(x=>x!==c.id):[...v,c.id])}
                  style={{background:on?"#000":"#fff",color:on?"#fff":"#111"}}>
                  {c.name}{c.package?` • ост:${c.package.left}`:""}
                </button>
              );
            })}
            {clients.length===0 && <div className="muted">Сначала добавьте клиентов</div>}
          </div>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <input className="in" style={{width:140}} type="number" placeholder="Ставка ₽" value={rate} onChange={e=>setRate(+e.target.value||0)}/>
            <span className="muted">за тренировку</span>
          </div>
          <div style={{display:"flex",justifyContent:"end"}}>
            <button className="btn" onClick={()=>{
              const s=fromLocal(start); const e=new Date(s.getTime()+dur*60000);
              setSessions(p=>[...p,{id:gid(),title:title||"Тренировка",start:s.toISOString(),end:e.toISOString(),rate,clients:ids,attendance:{}}]);
              setTitle(""); setIds([]);
            }}>Создать</button>
          </div>
        </div>
      );
    }

    /* ---- attendance + auto package balance ---- */
    const setAttendance=(sid,cid,val)=>{
      setSessions(prev=>prev.map(s=>{
        if(s.id!==sid) return s;
        const att={...(s.attendance||{})};
        const prevVal=att[cid];
        att[cid]=val;

        // списание/возврат из пакета при смене статуса
        const i=clients.findIndex(x=>x.id===cid);
        if(i>-1 && clients[i].package){
          setClients(cs=>cs.map((x,idx)=>{
            if(idx!==i) return x;
            let left=x.package.left;
            if(prevVal==="attended" && val!=="attended") left=Math.min(x.package.size,left+1);
            if(val==="attended" && prevVal!=="attended" && left>0) left=left-1;
            return {...x,package:{...x.package,left}};
          }));
        }
        return {...s,attendance:att};
      }));
    };

    /* ---- list ---- */
    function SessionTable(){
      const rows=[...sessions].sort((a,b)=>new Date(a.start)-new Date(b.start));
      const name=(id)=>clients.find(c=>c.id===id)?.name||"?";
      return (
        <div style={{overflow:"auto"}}>
          <table>
            <thead>
              <tr><th>Дата/время</th><th>Название</th><th>Клиенты</th><th>Статусы</th><th>Ставка</th><th></th></tr>
            </thead>
            <tbody>
              {rows.map(s=>{
                const a=new Date(s.start), b=new Date(s.end);
                return (
                  <tr key={s.id}>
                    <td>{dstr(a)} {tstr(a)}–{tstr(b)}</td>
                    <td>{s.title}</td>
                    <td>{(s.clients||[]).map(name).join(", ")||"—"}</td>
                    <td>
                      {(s.clients||[]).length===0 && <span className="muted">—</span>}
                      {(s.clients||[]).map(cid=>(
                        <div key={cid} style={{display:"flex",gap:6,alignItems:"center",marginBottom:6}}>
                          <span style={{width:120,fontSize:12}}>{name(cid)}</span>
                          <select className="in" value={(s.attendance||{})[cid]||"planned"}
                                  onChange={e=>setAttendance(s.id,cid,e.target.value)}>
                            <option value="planned">запланировано</option>
                            <option value="attended">пришёл</option>
                            <option value="missed">пропустил</option>
                            <option value="canceled">отмена</option>
                          </select>
                        </div>
                      ))}
                    </td>
                    <td>{s.rate?`${s.rate} ₽`:"—"}</td>
                    <td style={{textAlign:"right"}}>
                      <button className="btnD" onClick={()=>{ if(confirm("Удалить тренировку?")) setSessions(p=>p.filter(x=>x.id!==s.id)); }}>Удалить</button>
                    </td>
                  </tr>
                );
              })}
              {rows.length===0 && (
                <tr>
                  <td colSpan={6} style={{ textAlign: "center", color: "#666" }}>
                    Пока нет тренировок
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      );
    }

    /* ---- stats ---- */
    function Stats(){
      const totalRevenue = sessions.reduce((sum,s)=>sum+(s.rate||0),0);
      const byClient=new Map();
      sessions.forEach(s=>{
        (s.clients||[]).forEach(cid=>{
          const r=byClient.get(cid)||{name:clients.find(c=>c.id===cid)?.name||"?",attended:0,missed:0,planned:0,canceled:0};
          const st=(s.attendance||{})[cid]||"planned"; r[st]=(r[st]||0)+1; byClient.set(cid,r);
        })
      });
      const rows=[...byClient.values()];
      return (
        <div style={{display:"grid",gap:12}}>
          <div className="card"><div className="ttl">Итого</div>
            <div>Тренировок: <b>{sessions.length}</b></div>
            <div>Выручка (по ставкам): <b>{totalRevenue} ₽</b></div>
          </div>
          <div className="card"><div className="ttl">По клиентам</div>
            <table>
              <thead><tr><th>Клиент</th><th>Пришёл</th><th>Пропустил</th><th>План</th><th>Отмена</th><th>Пакет</th></tr></thead>
              <tbody>
                {rows.map(r=>{
                  const c=clients.find(x=>x.name===r.name);
                  const pkg=c?.package?`${c.package.left}/${c.package.size} • ${c.package.price} ₽`:"—";
                  return (
                    <tr key={r.name}>
                      <td>{r.name}</td><td>{r.attended||0}</td><td>{r.missed||0}</td>
                      <td>{r.planned||0}</td><td>{r.canceled||0}</td><td>{pkg}</td>
                    </tr>
                  );
                })}
                {rows.length===0 && (
                  <tr>
                    <td colSpan={6} style={{ textAlign: "center", color: "#666" }}>
                      Нет данных
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    /* ---- layout ---- */
    return (
      <div className="grid">
        <div style={{display:"grid",gap:12}}>
          <div className="card">
            <div className="ttl">Подопечные</div>
            <div style={{display:"flex",gap:8,marginBottom:8}}>
              <input className="in" placeholder="Поиск" value={q} onChange={e=>setQ(e.target.value)}/>
              <button className="btn" onClick={addClient}>+ Добавить</button>
            </div>
            <div style={{display:"grid",gap:8,maxHeight:360,overflow:"auto"}}>
              {clients
                .filter(c=>[c.name,c.phone,c.note].join(" ").toLowerCase().includes(q.toLowerCase()))
                .map(c=>(
                <div key={c.id} className="card" style={{ padding: 10 }}>
                  <div style={{fontWeight:600}}>{c.name}</div>
                  {c.phone && <div className="muted">{c.phone}</div>}
                  {c.package && <div className="muted">Пакет: {c.package.left}/{c.package.size} • {c.package.price} ₽</div>}
                  <div style={{display:"flex",gap:6,marginTop:6}}>
                    <button className="btnL" onClick={()=>editClient(c)}>Ред.</button>
                    <button className="btnD" onClick={()=>removeClient(c.id)}>Удалить</button>
                  </div>
                </div>
              ))}
              {clients.length===0 && <div className="muted">Добавьте первого клиента</div>}
            </div>
          </div>

          <div className="card">
            <div className="ttl">Быстрая запись</div>
            <QuickCreate/>
          </div>
        </div>

        <div style={{display:"grid",gap:12}}>
          {view==="list"  && <div className="card"><div className="ttl">Все тренировки</div><SessionTable/></div>}
          {view==="stats" && <Stats/>}
        </div>
      </div>
    );
  }

  ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>
</html>
